
// ===== Translation Data =====
const translations = {
    ko: {
        // Navigation
        'nav.personal': '개인 송금',
        'nav.business': '기업 송금',
        'nav.service': '서비스 안내',
        'nav.login': '로그인',
        'nav.register': '회원가입',
        'nav.language': '언어',
        'nav.remitGuide': '송금 서비스 안내',
        'nav.signupGuide': '가입 안내',
        'nav.customerCenter': '고객 센터',
        'nav.notice': '공지사항',
        'nav.faq': '자주 묻는 질문',
        'nav.inquiry': '1:1 문의',

        // Hero
        'hero.title': '해외송금,<br><span>이제는 쉽고 간편하게</span>',
        'hero.desc': '보내시는 분의 마음을 담아, 더 빠르고 더 저렴하게 전해드립니다. 언제 어디서나, 글로벌 기준의 빠르고 안전한 송금 솔루션',
        'hero.badge1': '최단 5분 송금',
        'hero.badge2': 'SGI 서울보증보험',
        'hero.badge3': '기획재정부 인가 (2018-7)',

        // Calculator
        'calc.title': '송금 시뮬레이션',
        'calc.send': '보내실 금액',
        'calc.maxAmount': '최대 송금액 {limit}원',
        'calc.rate': '실시간 환율 적용',
        'calc.receive': '받으실 금액',
        'calc.result': '상대방이 받는 금액',
        'calc.savings': '은행 대비 약 {amount} 더 받으세요!',
        'calc.btn': '지금 바로 송금하기',
        'calc.deposit': '입금할 금액',
        'calc.transferFee': '송금 수수료',
        'calc.withdrawalFee': '수취 수수료',
        'modal.limit.title': '송금 한도 초과',
        'modal.limit.memo': '외환거래법령에 따라 건당 최대 <b>$5,000(USD)</b>까지 송금이 가능합니다. 현재 환율 기준 송금 가능액인 <b>{limit}원</b>으로 조정되었습니다.',
        'modal.ok': '확인',

        // Features
        'features.title': '왜 withremit인가요?',
        'features.desc': '보내시는 분의 마음을 담아, 더 빠르고 더 저렴하게 전해드립니다.',
        'features.fast.title': '보다 빠르고',
        'features.fast.desc': '최단 5분 내 송금 완료! 급한 송금도 걱정 없이 빠르게 전달됩니다. 실시간 송금 현황을 확인하세요.',
        'features.cheap.title': '보다 편리하게',
        'features.cheap.desc': '복잡한 서류나 은행 방문 없이, 24시간 언제 어디서든 몇 번의 클릭만으로 해외 송금을 간단하게 완료하세요.',
        'features.safe.title': '보다 큰 혜택',
        'features.safe.desc': '국가가 인증한 업체라 더 든든하게! 보증보험 가입으로 소중한 자산을 안전하게 지켜드립니다.',

        // Countries
        'countries.title': '송금 가능 국가',
        'countries.desc': '전 세계 주요 국가로 빠르고 안전하게 송금하세요',
        'country.japan': '일본',
        'country.philippines': '필리핀',
        'country.china': '중국',
        'country.nepal': '네팔',
        'country.australia': '호주',
        'country.hongkong': '홍콩',
        'country.mongolia': '몽골',
        'country.vietnam': '베트남',
        'country.srilanka': '스리랑카',
        'country.bangladesh': '방글라데시',
        'currency.jpy_desc': 'JPY · 엔',
        'currency.php_desc': 'PHP · 페소',
        'currency.cny_desc': 'CNY · 위안',
        'currency.npr_desc': 'NPR · 루피',
        'currency.aud_desc': 'AUD · 달러',
        'currency.hkd_desc': 'HKD · 달러',
        'currency.mnt_desc': 'MNT · 투그릭',
        'currency.vnd_desc': 'VND · 동',
        'currency.lkr_desc': 'LKR · 루피',
        'currency.bdt_desc': 'BDT · 타카',

        // Trust
        'trust.title': '언제나 마음 편한 안심 송금',
        'trust.desc': '보다 빠르고, 보다 편리하게, 보다 큰 혜택으로 더 큰 만족!',
        'trust.business.title': '개인형 맞춤 송금',
        'trust.business.desc': '유학비, 생활비, 선물까지 상황에 맞춰 간편하게! 나에게 꼭 맞는 송금 방식을 제공합니다.',
        'trust.report.title': '한눈에 보는 송금 내역',
        'trust.report.desc': '실시간으로 송금 상태를 확인하세요. 복잡한 내역도 가계부처럼 한눈에 관리할 수 있습니다.',
        'trust.support.title': '친절한 고객 상담',
        'trust.support.desc': '궁금한 점이 생기면 언제든 문의해 주세요. 전문 상담팀이 친절하고 빠르게 도와드립니다.',

        // CTA
        'cta.title': '지금 바로 시작하세요',
        'cta.desc': '회원가입 후 첫 송금 시 특별 혜택을 드립니다. 더 현명한 해외송금, withremit과 함께하세요.',
        'cta.btn': '무료로 가입하기',

        // Contact
        'contact.section.title': '고객센터',
        'contact.section.desc': '궁금한 점이 있으시면 언제든지 문의해 주세요',
        'contact.title': '연락처',
        'contact.korean': '한국어 상담',
        'contact.japanese': '日本語 相談',
        'contact.email': '이메일',
        'contact.hours': '상담 시간 안내',
        'contact.weekday': '평일',
        'contact.weekend': '토요일 · 공휴일',
        'contact.closed': '* 일요일 휴무',

        // Footer
        'footer.company': '회사소개',
        'footer.privacy': '개인정보처리방침',
        'footer.terms': '이용약관',
        'footer.antisocial': '반사회적세력에 대한 방침',
        'footer.fraud': '사기피해주의',
        'footer.license': '기획재정부 인가 소액해외송금업체 (등록번호: 2018-7)',

        // Banners
        'banner.referral.title': '친구도 나도, 송금 수수료 0원!',
        'banner.referral.desc': '친구가 가입 후 첫 송금을 마치면 두 분 모두에게 수수료 무료 쿠폰을 드립니다.',
        'banner.referral.alt': '친구 추천 이벤트',
        'banner.birthday.title': '해피 벌스데이! 위드레미트가 드리는 생일 선물',
        'banner.birthday.desc': '생일인 달에는 송금 수수료가 무료! 지금 쿠폰함에서 확인해 보세요.',
        'banner.birthday.alt': '생일 쿠폰 이벤트',
        'banner.security.title': '국가가 인증하고 서울보증보험이 약속합니다.',
        'banner.security.desc': '기획재정부 인가 및 SGI 서울보증보험 가입으로 단 1원도 안심하고 보내세요.',
        'banner.security.alt': '보안 안심 송금'
    },
    en: {
        // Navigation
        'nav.personal': 'Personal',
        'nav.business': 'Business',
        'nav.service': 'Services',
        'nav.login': 'Login',
        'nav.register': 'Sign Up',
        'nav.language': 'Language',
        'nav.remitGuide': 'Remittance Service Guide',
        'nav.signupGuide': 'Registration Guide',
        'nav.customerCenter': 'Customer Center',
        'nav.notice': 'Notice',
        'nav.faq': 'FAQ',
        'nav.inquiry': '1:1 Inquiry',

        // Hero
        'hero.title': 'International Remittance,<br><span>Now Easy and Simple</span>',
        'hero.desc': 'We deliver your money with care, faster and more affordably. Anytime, anywhere, fast and secure global remittance solutions',
        'hero.badge1': '5 min transfer',
        'hero.badge2': 'SGI Guaranteed',
        'hero.badge3': 'Licensed (2018-7)',

        // Calculator
        'calc.title': 'Transfer Simulation',
        'calc.send': 'Send Amount',
        'calc.maxAmount': 'Max {limit} KRW',
        'calc.rate': 'Real-time exchange rate',
        'calc.receive': 'Receive Amount',
        'calc.result': 'Recipient receives',
        'calc.savings': 'Get about {amount} more than banks!',
        'calc.btn': 'Send Money Now',
        'calc.deposit': 'Deposit Amount',
        'calc.transferFee': 'Transfer Fee',
        'calc.withdrawalFee': 'Withdrawal Fee',
        'modal.limit.title': 'Transfer Limit Exceeded',
        'modal.limit.memo': 'Under the Foreign Exchange Transactions Act, you can transfer up to <b>$5,000(USD)</b> per transaction. The amount has been adjusted to <b>{limit} KRW</b> based on the current exchange rate.',
        'modal.ok': 'Confirm',

        // Features
        'features.title': 'Why withremit?',
        'features.desc': 'We deliver your money with care, faster and more affordably.',
        'features.fast.title': 'Faster',
        'features.fast.desc': 'Transfer completed in as fast as 5 minutes! Send urgent payments without worry. Track your transfer status in real-time.',
        'features.cheap.title': 'More Convenient',
        'features.cheap.desc': 'No complicated paperwork or bank visits. Complete your international transfer anytime, anywhere with just a few clicks 24/7.',
        'features.safe.title': 'Greater Benefits',
        'features.safe.desc': 'Government-certified provider for peace of mind! Your assets are protected with guarantee insurance.',

        // Countries
        'countries.title': 'Available Countries',
        'countries.desc': 'Send money safely to major countries worldwide',
        'country.japan': 'Japan',
        'country.philippines': 'Philippines',
        'country.china': 'China',
        'country.nepal': 'Nepal',
        'country.australia': 'Australia',
        'country.hongkong': 'Hong Kong',
        'country.mongolia': 'Mongolia',
        'country.vietnam': 'Vietnam',
        'country.srilanka': 'Sri Lanka',
        'country.bangladesh': 'Bangladesh',
        'currency.jpy_desc': 'JPY · Yen',
        'currency.php_desc': 'PHP · Peso',
        'currency.cny_desc': 'CNY · Yuan',
        'currency.npr_desc': 'NPR · Rupee',
        'currency.aud_desc': 'AUD · Dollar',
        'currency.hkd_desc': 'HKD · Dollar',
        'currency.mnt_desc': 'MNT · Tugrik',
        'currency.vnd_desc': 'VND · Dong',
        'currency.lkr_desc': 'LKR · Rupee',
        'currency.bdt_desc': 'BDT · Taka',

        // Trust
        'trust.title': 'Peace of Mind Remittance',
        'trust.desc': 'Faster, more convenient, and greater benefits for greater satisfaction!',
        'trust.business.title': 'Personalized Remittance',
        'trust.business.desc': 'Tuition, living expenses, gifts, and more - easily customized! We provide the remittance solution that fits you best.',
        'trust.report.title': 'Transaction History at a Glance',
        'trust.report.desc': 'Check your transfer status in real-time. Manage complex transactions like a ledger at a glance.',
        'trust.support.title': 'Friendly Customer Service',
        'trust.support.desc': 'Contact us anytime with questions. Our expert support team is here to help you kindly and quickly.',

        // CTA
        'cta.title': 'Get Started Today',
        'cta.desc': 'Special benefits for your first transfer. Smart remittance with withremit.',
        'cta.btn': 'Sign Up Free',

        // Contact
        'contact.section.title': 'Contact Us',
        'contact.section.desc': 'Feel free to contact us anytime',
        'contact.title': 'Contact',
        'contact.korean': 'Korean Support',
        'contact.japanese': 'Japanese Support',
        'contact.email': 'Email',
        'contact.hours': 'Business Hours',
        'contact.weekday': 'Weekdays',
        'contact.weekend': 'Sat · Holidays',
        'contact.closed': '* Closed on Sundays',

        // Footer
        'footer.company': 'About Us',
        'footer.privacy': 'Privacy Policy',
        'footer.terms': 'Terms of Service',
        'footer.antisocial': 'Anti-Social Forces Policy',
        'footer.fraud': 'Fraud Warning',
        'footer.license': 'Licensed Remittance Provider (Reg. No: 2018-7)',

        // Banners
        'banner.referral.title': 'Zero fees for both you and your friend!',
        'banner.referral.desc': 'Receive a free fee coupon for both when your friend completes their first transfer.',
        'banner.referral.alt': 'Referral Event',
        'banner.birthday.title': 'Happy Birthday! A gift from WithRemit',
        'banner.birthday.desc': 'Free transfer fees during your birthday month! Check your coupon box now.',
        'banner.birthday.alt': 'Birthday Coupon Event',
        'banner.security.title': 'Certified by the government, guaranteed by SGI.',
        'banner.security.desc': 'Send even a single won with peace of mind, fully licensed and insured.',
        'banner.security.alt': 'Security & Trust'
    },
    ja: {
        // Navigation
        'nav.personal': '個人送金',
        'nav.business': '法人送金',
        'nav.service': 'サービス案内',
        'nav.login': 'ログイン',
        'nav.register': '会員登録',
        'nav.language': '言語',
        'nav.remitGuide': '送金サービス案内',
        'nav.signupGuide': '登録案内',
        'nav.customerCenter': 'カスタマーセンター',
        'nav.notice': 'お知らせ',
        'nav.faq': 'よくある質問',
        'nav.inquiry': '1:1 お問い合わせ',

        // Hero
        'hero.title': '海外送金、<br><span>今はもっと簡単に</span>',
        'hero.desc': '送る方の気持ちを込めて、より速く、より安くお届けします。いつでもどこでも、グローバル基準の速くて安全な送金ソリューション',
        'hero.badge1': '最短5分送金',
        'hero.badge2': 'SGI保証保険',
        'hero.badge3': '政府認可 (2018-7)',

        // Calculator
        'calc.title': '送金シミュレーション',
        'calc.send': '送金額',
        'calc.maxAmount': '最大送金額 {limit}ウォン',
        'calc.rate': 'リアルタイム為替レート適用',
        'calc.receive': '受取額',
        'calc.result': '受取人が受け取る金額',
        'calc.savings': '銀行より約{amount}多く受け取れます！',
        'calc.btn': '今すぐ送金する',
        'calc.deposit': '入金額',
        'calc.transferFee': '送金手数料',
        'calc.withdrawalFee': '出金手数料',
        'modal.limit.title': '送金限度額超過',
        'modal.limit.memo': '外国為替取引法に基づき、1回につき最大<b>5,000米ドル(USD)</b>까지 送金可能です。現在の為替レートに基づく送金可能額の <b>{limit}ウォン</b>に調整されました。',
        'modal.ok': '確認',

        // Features
        'features.title': 'なぜwithremit？',
        'features.desc': '送る方の気持ちを込めて、より速く、より安くお届けします。',
        'features.fast.title': 'より速く',
        'features.fast.desc': '最短5分で送金完了！急な送金も心配なく、速やかにお届けします。リアルタイムで送金状況を確認できます。',
        'features.cheap.title': 'より便利に',
        'features.cheap.desc': '複雑な書類や銀行訪問なしで、24時間いつでもどこでも数回のクリックで海外送金を簡単に完了できます。',
        'features.safe.title': 'より大きな特典',
        'features.safe.desc': '国が認証した業者で、より安心！保証保険加入で大切な資産を安全に守ります。',

        // Countries
        'countries.title': '送金可能国',
        'countries.desc': '世界の主要国へ速くて安全に送金',
        'country.japan': '日本',
        'country.philippines': 'フィリピン',
        'country.china': '中国',
        'country.nepal': 'ネパール',
        'country.australia': 'オーストラリア',
        'country.hongkong': '香港',
        'country.mongolia': 'モンゴル',
        'country.vietnam': 'ベトナム',
        'country.srilanka': 'スリランカ',
        'country.bangladesh': 'バングラデシュ',
        'currency.jpy_desc': 'JPY · 円',
        'currency.php_desc': 'PHP · ペソ',
        'currency.cny_desc': 'CNY · 元',
        'currency.npr_desc': 'NPR · ルピー',
        'currency.aud_desc': 'AUD · ドル',
        'currency.hkd_desc': 'HKD · ドル',
        'currency.mnt_desc': 'MNT · トゥグルグ',
        'currency.vnd_desc': 'VND · ドン',
        'currency.lkr_desc': 'LKR · ルピー',
        'currency.bdt_desc': 'BDT · タカ',

        // Trust
        'trust.title': 'いつでも安心の送金',
        'trust.desc': 'より速く、より便利に、より大きな特典でさらに満足！',
        'trust.business.title': '個人向けカスタム送金',
        'trust.business.desc': '学費、生活費、贈り物まで状況に合わせて簡単に！あなたにぴったりの送金方法を提供します。',
        'trust.report.title': '一目で分かる送金履歴',
        'trust.report.desc': 'リアルタイムで送金状態を確認できます。複雑な履歴も家計簿のように一目で管理できます。',
        'trust.support.title': '親切なカスタマーサービス',
        'trust.support.desc': '疑問があればいつでもお問い合わせください。専門サポートチームが親切かつ迅速に対応します。',

        // CTA
        'cta.title': '今すぐ始めよう',
        'cta.desc': '会員登録後、初回送金で特典あり。withremitで賢く送金。',
        'cta.btn': '無料で登録',

        // Contact
        'contact.section.title': 'お問い合わせ',
        'contact.section.desc': 'お気軽にお問い合わせください',
        'contact.title': '連絡先',
        'contact.korean': '韓国語サポート',
        'contact.japanese': '日本語サポート',
        'contact.email': 'メール',
        'contact.hours': '営業時間',
        'contact.weekday': '平日',
        'contact.weekend': '土曜・祝日',
        'contact.closed': '* 日曜休業',

        // Footer
        'footer.company': '会社概要',
        'footer.privacy': 'プライバシーポリシー',
        'footer.terms': '利用規約',
        'footer.antisocial': '反社会的勢力への方針',
        'footer.fraud': '詐欺被害注意',
        'footer.license': '政府認可送金業者 (登録番号: 2018-7)',

        // Banners
        'banner.referral.title': '友達も私も、送金手数料0円！',
        'banner.referral.desc': '友達が登録後に初送金を完了すると、お二人に手数料無料クーポンを差し上げます。',
        'banner.referral.alt': '友達招待イベント',
        'banner.birthday.title': 'ハッピーバースデー！WithRemitからの誕生日プレゼント',
        'banner.birthday.desc': '誕生月は送金手数料が無料！今すぐクーポンボックスを確認してください。',
        'banner.birthday.alt': '誕生日クーポンイベント',
        'banner.security.title': '政府公認、ソウル保証保険が約束します。',
        'banner.security.desc': '政府認可およびSGIソウル保証保険加入で、1円からでも安心してお送りください。',
        'banner.security.alt': '安心・安全送金'
    },
    zh: {
        // Navigation
        'nav.personal': '个人汇款',
        'nav.business': '企业汇款',
        'nav.service': '服务介绍',
        'nav.login': '登录',
        'nav.register': '注册',
        'nav.language': '语言',
        'nav.remitGuide': '汇款服务介绍',
        'nav.signupGuide': '注册指南',
        'nav.customerCenter': '客服中心',
        'nav.notice': '公告',
        'nav.faq': '常见问题',
        'nav.inquiry': '1:1 咨询',

        // Hero
        'hero.title': '海外汇款，<br><span>现在更简单便捷</span>',
        'hero.desc': '用心传递您的心意，更快更实惠。随时随地，全球标准的快速安全汇款解决方案',
        'hero.badge1': '最快5分钟',
        'hero.badge2': 'SGI保险担保',
        'hero.badge3': '政府许可 (2018-7)',

        // Calculator
        'calc.title': '汇款模拟',
        'calc.send': '汇款金额',
        'calc.maxAmount': '最高 {limit} 韩元',
        'calc.rate': '实时汇率',
        'calc.receive': '收款金额',
        'calc.result': '收款人收到',
        'calc.savings': '比银行多收{amount}！',
        'calc.btn': '立即汇款',
        'calc.deposit': '存款金额',
        'calc.transferFee': '汇款手续费',
        'calc.withdrawalFee': '提款手续费',
        'modal.limit.title': '汇款额度超限',
        'modal.limit.memo': '根据外汇交易法令，单笔最高可汇款 <b>5,000 美元 (USD)</b>。已根据当前汇率调整为最高汇款额 <b>{limit} 韩元</b>。',
        'modal.ok': '确认',

        // Features
        'features.title': '为什么选择withremit？',
        'features.desc': '用心传递您的心意，更快更实惠。',
        'features.fast.title': '更快',
        'features.fast.desc': '最快5分钟完成汇款！紧急汇款也无需担心，快速送达。实时查看汇款状态。',
        'features.cheap.title': '更便捷',
        'features.cheap.desc': '无需复杂手续或银行访问，24小时随时随地，只需几次点击即可轻松完成海外汇款。',
        'features.safe.title': '更多优惠',
        'features.safe.desc': '国家认证机构，更放心！担保保险加持，安全守护您的宝贵资产。',

        // Countries
        'countries.title': '可汇款国家',
        'countries.desc': '安全汇款至全球主要国家',
        'country.japan': '日本',
        'country.philippines': '菲律宾',
        'country.china': '中国',
        'country.nepal': '尼泊尔',
        'country.australia': '澳大利亚',
        'country.hongkong': '香港',
        'country.mongolia': '蒙古',
        'country.vietnam': '越南',
        'country.srilanka': '斯里兰卡',
        'country.bangladesh': '孟加拉国',
        'currency.jpy_desc': 'JPY · 日元',
        'currency.php_desc': 'PHP · 比索',
        'currency.cny_desc': 'CNY · 元',
        'currency.npr_desc': 'NPR · 卢比',
        'currency.aud_desc': 'AUD · 澳元',
        'currency.hkd_desc': 'HKD · 港元',
        'currency.mnt_desc': 'MNT · 图格里克',
        'currency.vnd_desc': 'VND · 越南盾',
        'currency.lkr_desc': 'LKR · 卢比',
        'currency.bdt_desc': 'BDT · 塔卡',

        // Trust
        'trust.title': '随时安心的汇款',
        'trust.desc': '更快、更便捷、更多优惠，带来更大满足！',
        'trust.business.title': '个性化定制汇款',
        'trust.business.desc': '学费、生活费、礼物，根据情况轻松定制！为您提供最合适的汇款方式。',
        'trust.report.title': '一目了然的汇款记录',
        'trust.report.desc': '实时查看汇款状态。复杂记录也能像账本一样一目了然地管理。',
        'trust.support.title': '贴心客户服务',
        'trust.support.desc': '有疑问随时咨询我们。专业支持团队将亲切快速地为您解答。',

        // CTA
        'cta.title': '立即开始',
        'cta.desc': '注册后首次汇款享特惠。withremit智能汇款。',
        'cta.btn': '免费注册',

        // Contact
        'contact.section.title': '客服中心',
        'contact.section.desc': '如有疑问请随时联系我们',
        'contact.title': '联系方式',
        'contact.korean': '韩语客服',
        'contact.japanese': '日语客服',
        'contact.email': '邮箱',
        'contact.hours': '服务时间',
        'contact.weekday': '工作日',
        'contact.weekend': '周六·节假日',
        'contact.closed': '* 周日休息',

        // Footer
        'footer.company': '公司简介',
        'footer.privacy': '隐私政策',
        'footer.terms': '服务条款',
        'footer.antisocial': '反社会势力政策',
        'footer.fraud': '诈骗警示',
        'footer.license': '政府许可汇款机构 (登记号: 2018-7)',

        // Banners
        'banner.referral.title': '好友和你，转账手续费全免！',
        'banner.referral.desc': '好友注册并完成首次转账后，双方均可获得免手续费优惠券。',
        'banner.referral.alt': '好友推荐活动',
        'banner.birthday.title': '生日快乐！WithRemit 送出的生日礼物',
        'banner.birthday.desc': '生日月份转账手续费全免！请立即查看您的优惠券。',
        'banner.birthday.alt': '生日优惠券活动',
        'banner.security.title': '政府认证，首尔保证保险承诺保驾护航。',
        'banner.security.desc': '持政府许可并加入 SGI 首尔保证保险，每一分钱都能放心汇出。',
        'banner.security.alt': '安全可靠汇款'
    }
};

// 송금 한도 설정을 위한 상수 (기준: USD)
const KRW_PER_USD = 1350;
const MAX_USD = 5000;
const MAX_KRW_LIMIT = MAX_USD * KRW_PER_USD; // 6,750,000원

// 모달 열기/닫기 함수
function showLimitModal() {
    const modal = document.getElementById('limitModal');
    const msg = document.getElementById('modalMessage');
    const key = msg.getAttribute('data-i18n');
    const template = translations[currentLang][key];
    msg.innerHTML = template.replace('{limit}', MAX_KRW_LIMIT.toLocaleString());
    modal.classList.add('active');
}

function closeLimitModal() {
    const modal = document.getElementById('limitModal');
    modal.classList.remove('active');
}

// ===== Exchange Rates (Sample Data) =====
const exchangeRates = {
    JPY: { rate: 0.1112, name: '일본', currency: '엔', symbol: '¥', flagImg: 'jp' },
    PHP: { rate: 0.0421, name: '필리핀', currency: '페소', symbol: '₱', flagImg: 'ph' },
    CNY: { rate: 0.0054, name: '중국', currency: '위안', symbol: '¥', flagImg: 'cn' },
    NPR: { rate: 0.1004, name: '네팔', currency: '루피', symbol: 'रू', flagImg: 'np' },
    AUD: { rate: 0.0011, name: '호주', currency: '달러', symbol: 'A$', flagImg: 'au' },
    HKD: { rate: 0.0059, name: '홍콩', currency: '달러', symbol: 'HK$', flagImg: 'hk' },
    MNT: { rate: 2.5830, name: '몽골', currency: '투그릭', symbol: '₮', flagImg: 'mn' },
    VND: { rate: 18.5200, name: '베트남', currency: '동', symbol: '₫', flagImg: 'vn' },
    LKR: { rate: 0.2450, name: '스리랑카', currency: '루피', symbol: '௹', flagImg: 'lk' },
    BDT: { rate: 0.0815, name: '방글라데시', currency: '타카', symbol: '৳', flagImg: 'bd' }
};

const currencySymbols = {
    'JPY': '¥', 'PHP': '₱', 'CNY': '¥', 'NPR': 'रू', 'AUD': 'A$', 'HKD': 'HK$', 'MNT': '₮', 'VND': '₫', 'LKR': '௹', 'BDT': '৳'
};

const withdrawalFees = {
    'JPY': 660,
    'PHP': 40129,
    'CNY': 4713,
    'NPR': 97607,
    'AUD': 0,
    'HKD': 0,
    'MNT': 0,
    'VND': 0,
    'LKR': 0,
    'BDT': 0
};

let selectedCurrency = 'JPY';
let currentLang = 'ko';

// Bank comparison rates
const bankFeePercent = 3.5;


// 환율 안내 문구 업데이트 함수
function updateRateDisplay() {
    const exchangeRateEl = document.getElementById('exchangeRate');
    if (exchangeRateEl) {
        const rate = exchangeRates[selectedCurrency].rate;
        exchangeRateEl.textContent = `1 KRW = ${rate.toFixed(4)} ${selectedCurrency}`;
    }
}

// 보낼 금액 입력 시 호출
function handleSendAmountInput(e) {
    let rawValue = e.target.value.replace(/[^\d]/g, '');
    if (!rawValue) {
        e.target.value = '';
        if (document.getElementById('receiveAmount')) document.getElementById('receiveAmount').value = '';
        return;
    }

    let numValue = parseInt(rawValue);

    if (numValue > MAX_KRW_LIMIT) {
        numValue = MAX_KRW_LIMIT;
        e.target.value = numValue.toLocaleString('ko-KR');
        showLimitModal();
    } else {
        e.target.value = numValue.toLocaleString('ko-KR');
    }

    const rate = exchangeRates[selectedCurrency].rate;
    const convertedAmount = Math.floor(numValue * rate);

    const receiveInput = document.getElementById('receiveAmount');
    if (receiveInput) {
        receiveInput.value = convertedAmount.toLocaleString('ko-KR');
    }

    updateFees(numValue, convertedAmount);
    updateRateDisplay();
}

function updateFees(krw, foreignAmount) {
    const transferFeeRate = selectedCurrency === 'NPR' ? 0.005 : 0.01;
    const transferFee = Math.floor(krw * transferFeeRate);
    const depositTotal = krw + transferFee;
    const withdrawalFee = withdrawalFees[selectedCurrency] || 0;
    const symbol = currencySymbols[selectedCurrency] || '¥';

    document.getElementById('depositAmount').textContent = `₩${depositTotal.toLocaleString()}`;
    document.getElementById('transferFee').textContent = `₩${transferFee.toLocaleString()}`;
    document.getElementById('withdrawalFee').textContent = `${symbol}${withdrawalFee.toLocaleString()}`;

    updateSavings(krw, foreignAmount);
}

// ===== DOM Elements =====
const sendAmountInput = document.getElementById('sendAmount');
const receiveCurrencySelect = document.getElementById('receiveCurrency');
const receiveAmountEl = document.getElementById('receiveAmount');
const exchangeRateEl = document.getElementById('exchangeRate');
const savingsEl = document.getElementById('savings');
const countryCards = document.querySelectorAll('.country-card');

// Custom Dropdown Elements
const currencyDropdown = document.getElementById('currencyDropdown');
const currencyBtn = document.getElementById('currencyBtn');
const currencyOptions = document.getElementById('currencyOptions');
const currencyFlag = document.getElementById('receiveCurrencyFlag');
const currencyCode = document.getElementById('receiveCurrencyCode');

// ===== Translation Functions =====
function t(key) {
    return translations[currentLang][key] || translations['ko'][key] || key;
}

function applyTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const translation = t(key);
        if (translation) {
            if (el.tagName === 'IMG') {
                el.alt = translation;
            } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translation;
            } else if (key === 'calc.maxAmount') {
                // Replace {limit} placeholder with actual max limit
                el.innerHTML = translation.replace('{limit}', MAX_KRW_LIMIT.toLocaleString('ko-KR'));
            } else {
                el.innerHTML = translation;
            }
        }
    });
    document.documentElement.lang = currentLang;

    const sendInput = document.getElementById('sendAmount');
    if (sendInput && sendInput.value) {
        handleSendAmountInput({ target: sendInput });
    }
}

function changeLanguage(lang) {
    currentLang = lang;

    const langSelect = document.getElementById('langSelect');
    const mobileLangSelect = document.getElementById('mobileLangSelect');
    const guestSidebarLangSelect = document.getElementById('guestSidebarLangSelect');

    if (langSelect) langSelect.value = lang;
    if (mobileLangSelect) mobileLangSelect.value = lang;
    if (guestSidebarLangSelect) guestSidebarLangSelect.value = lang;

    applyTranslations();

    const sendInput = document.getElementById('sendAmount');
    if (sendInput && sendInput.value) {
        handleSendAmountInput({ target: sendInput });
    }

    localStorage.setItem('preferredLanguage', lang);
}

// ===== Calculator Functions =====
function formatNumber(num, decimals = 0) {
    return new Intl.NumberFormat('ko-KR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    }).format(num);
}

function calculateTransfer() {
    const sendAmount = parseFloat(sendAmountInput?.value.replace(/,/g, '')) || 0;
    const selectedCurrency = receiveCurrencySelect?.value || 'JPY';
    const rateInfo = exchangeRates[selectedCurrency];

    if (!rateInfo || sendAmount <= 0) {
        if (receiveAmountEl) receiveAmountEl.textContent = `${rateInfo ? rateInfo.symbol : '¥'} 0`;
        return;
    }

    // Calculate receive amount
    const receiveAmount = sendAmount / rateInfo.rate;

    // Calculate bank comparison
    const bankReceiveAmount = receiveAmount * (1 - bankFeePercent / 100);
    const savings = receiveAmount - bankReceiveAmount;

    // Update display
    if (receiveAmountEl) {
        receiveAmountEl.textContent = `${rateInfo.symbol} ${formatNumber(receiveAmount)}`;
    }
    if (exchangeRateEl) {
        exchangeRateEl.textContent = `1 KRW = ${rateInfo.rate.toFixed(6)} ${selectedCurrency}`;
    }
    if (savingsEl) {
        const compareText = t('calc.compare')
            .replace('{amount}', formatNumber(savings))
            .replace('{currency}', selectedCurrency);
        savingsEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>${compareText}</span>`;
    }

    // Update 상대방이 받는 금액
    const receiveAmountDisplay = document.getElementById('receiveAmountDisplay');
    if (receiveAmountDisplay) {
        receiveAmountDisplay.textContent = `${rateInfo.symbol} ${formatNumber(receiveAmount)}`;
    }
}

function handleAmountInput(e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value) {
        value = formatNumber(parseInt(value));
    }
    e.target.value = value;
    calculateTransfer();
}

function handleCurrencyChange(currency, flagUrl) {
    selectedCurrency = currency;

    const receiveCurrencyFlag = document.getElementById('receiveCurrencyFlag');
    const receiveCurrencyCode = document.getElementById('receiveCurrencyCode');
    const receiveCurrencySymbol = document.getElementById('receiveCurrencySymbol');
    const receiveCurrencyInput = document.getElementById('receiveCurrency');

    if (receiveCurrencyFlag && flagUrl) receiveCurrencyFlag.src = flagUrl;
    if (receiveCurrencyCode) receiveCurrencyCode.textContent = currency;
    if (receiveCurrencySymbol) {
        receiveCurrencySymbol.textContent = currencySymbols[currency] || '¥';
    }
    if (receiveCurrencyInput) receiveCurrencyInput.value = currency;

    // 계산 실행
    const sendInput = document.getElementById('sendAmount');
    if (sendInput) handleSendAmountInput({ target: sendInput });

    updateRateDisplay();
}

// Toggle dropdown
function toggleCurrencyDropdown() {
    if (currencyDropdown) {
        currencyDropdown.classList.toggle('open');
    }
}

// Close dropdown when clicking outside
function closeCurrencyDropdown(e) {
    if (currencyDropdown && !currencyDropdown.contains(e.target)) {
        currencyDropdown.classList.remove('open');
    }
}

// ===== Country Card Click Handler =====
function handleCountryClick(e) {
    const card = e.currentTarget;
    const currency = card.dataset.currency;

    if (currency && exchangeRates[currency]) {
        const flagImg = exchangeRates[currency].flagImg;
        const flagUrl = `images/${flagImg}.png`;
        handleCurrencyChange(currency, flagUrl);
        document.querySelector('.hero').scrollIntoView({ behavior: 'smooth' });
    }
}

// ===== Header Scroll Effect =====
function handleScroll() {
    const header = document.querySelector('.header');
    if (header) {
        if (window.scrollY > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    }
}

// ===== Mobile Menu Toggle =====
// ===== Mobile Menu Toggle (Guest) =====
function toggleMobileMenu() {
    // Desktop Dashboard: Toggle Sidebar Collapse
    // Only applies if body has 'db-body' class (Dashboard pages)
    if (window.innerWidth > 1024 && document.body.classList.contains('db-body')) {
        document.body.classList.toggle('db-collapsed');
        return;
    }

    // Mobile/Tablet OR Landing Page: Toggle Drawer
    const sidebar = document.getElementById('guestSidebar');
    const overlay = document.getElementById('guestSidebarOverlay');
    const menuBtn = document.querySelector('.mobile-menu-btn');

    if (sidebar && overlay) {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');

        // Prevent body scroll when sidebar is open
        if (sidebar.classList.contains('active')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    }
}

// Close sidebar event listeners
document.addEventListener('DOMContentLoaded', () => {
    const closeBtn = document.getElementById('guestSidebarClose');
    const overlay = document.getElementById('guestSidebarOverlay');
    const sidebar = document.getElementById('guestSidebar');

    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        });
    }

    if (overlay) {
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        });
    }
});

// ===== Language Selection =====
function handleLanguageChange(e) {
    changeLanguage(e.target.value);
}

// ===== Intersection Observer for Animations =====
function initAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-fade-in');
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    document.querySelectorAll('.feature-card, .country-card, .trust-item').forEach(el => {
        observer.observe(el);
    });
}

// ===== Auto-detect Language =====
function detectLanguage() {
    const savedLang = localStorage.getItem('preferredLanguage');
    if (savedLang && translations[savedLang]) {
        changeLanguage(savedLang);
        return;
    }

    const userLang = navigator.language || navigator.userLanguage;
    const langMap = { 'ko': 'ko', 'ja': 'ja', 'zh': 'zh', 'en': 'en' };
    const detectedLang = langMap[userLang.split('-')[0]] || 'ko';

    changeLanguage(detectedLang);
}

// ===== Initialize =====
document.addEventListener('DOMContentLoaded', () => {
    // Calculator event listeners
    const sendAmountInput = document.getElementById('sendAmount');
    const receiveAmountInput = document.getElementById('receiveAmount');

    if (sendAmountInput) {
        sendAmountInput.addEventListener('input', handleSendAmountInput);
        sendAmountInput.value = '1,000,000';
        // 초기 계산 실행
        setTimeout(() => {
            handleSendAmountInput({ target: sendAmountInput });
        }, 100);
    }

    if (receiveAmountInput) {
        receiveAmountInput.addEventListener('input', handleReceiveAmountInput);
    }

    // Custom currency dropdown
    if (currencyBtn) {
        currencyBtn.addEventListener('click', toggleCurrencyDropdown);
    }

    // Currency options click
    document.querySelectorAll('.calc-currency-option').forEach(option => {
        option.addEventListener('click', () => {
            const currency = option.dataset.value;
            const flagUrl = option.querySelector('img').src; // 이미지 경로 추출
            handleCurrencyChange(currency, flagUrl); // 두 값을 모두 보냄
            document.getElementById('currencyDropdown').classList.remove('open');
        });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', closeCurrencyDropdown);

    // Country cards click
    countryCards.forEach(card => {
        card.addEventListener('click', handleCountryClick);
    });

    // Header scroll
    window.addEventListener('scroll', handleScroll);

    // Mobile menu
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', toggleMobileMenu);
    }

    // Language selection
    const langSelect = document.getElementById('langSelect');
    if (langSelect) {
        langSelect.addEventListener('change', handleLanguageChange);
    }

    const mobileLangSelect = document.getElementById('mobileLangSelect');
    if (mobileLangSelect) {
        mobileLangSelect.addEventListener('change', handleLanguageChange);
    }

    const guestSidebarLangSelect = document.getElementById('guestSidebarLangSelect');
    if (guestSidebarLangSelect) {
        guestSidebarLangSelect.addEventListener('change', handleLanguageChange);
    }

    // Initialize
    detectLanguage();
    initAnimations();

    // Set initial selected state
    document.querySelector('.calc-currency-option[data-value="JPY"]')?.classList.add('selected');
});

// ===== Smooth Scroll =====
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
        }
        // Close mobile menu if open
        document.querySelector('.mobile-nav')?.classList.remove('active');
    });
});

function handleReceiveAmountInput(e) {
    let rawValue = e.target.value.replace(/[^\d]/g, '');
    if (!rawValue) {
        e.target.value = '';
        document.getElementById('sendAmount').value = '';
        return;
    }

    let numValue = parseInt(rawValue);
    const rate = exchangeRates[selectedCurrency].rate;
    let krwAmount = Math.floor(numValue / rate);

    if (krwAmount > MAX_KRW_LIMIT) {
        krwAmount = MAX_KRW_LIMIT;
        numValue = Math.floor(MAX_KRW_LIMIT * rate);
        e.target.value = numValue.toLocaleString('ko-KR');
        showLimitModal();
    } else {
        e.target.value = numValue.toLocaleString('ko-KR');
    }

    document.getElementById('sendAmount').value = krwAmount.toLocaleString('ko-KR');
    updateFees(krwAmount, numValue);
}

function updateSavings(krw, foreignAmount) {
    const savingsElement = document.getElementById('savings');
    if (!savingsElement) return;

    const currentRate = exchangeRates[selectedCurrency].rate;
    const bankAmount = Math.floor(krw * (currentRate * 0.965));
    const savings = foreignAmount - bankAmount;
    const symbol = currencySymbols[selectedCurrency] || '¥';

    // 현재 언어의 템플릿 가져오기
    const template = translations[currentLang]['calc.savings'] || translations['ko']['calc.savings'];
    const savingsText = template.replace('{amount}', `<strong>${symbol} ${savings.toLocaleString()}</strong>`);

    savingsElement.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>${savingsText}</span>
    `;
}

let keypadMode = 'abc';
let isShift = false;
let activeInputId = null;
let passwordValues = {}; // Store real values: { 'inputID': 'actualValue' }
let maskingTimers = {}; // Store timers for masking delay

const keyboardLayouts = {
    num: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'Del'],
    abc: [['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'], ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'], ['Shift', 'z', 'x', 'c', 'v', 'b', 'n', 'm']],
    spec: [['-', '/', ':', ';', '(', ')', '$', '&', '@', '"'], ['.', '?', '!', "'", ',', '_', '\\', '|', '~', '<'], ['>', '`', '[', ']', '{', '}', '#', '%', '^', '*']]
};

// function toggleKeypad moved to end of file
// function handleKeyInput kept here as it is helper logic
// But wait, the previous tool call ADDED the new toggleKeypad at the END.
// So now I have TWO toggleKeypad functions.
// I should remove the first one (lines 966-1010) AND likely correct the handleKeyInput since I claimed I would update it but I didn't in the previous block.
// Actually handleKeyInput was fine, except I verified logic is correct.
// So I just need to remove the first toggleKeypad.

function handleDelete() {
    if (!activeInputId) return;
    const input = document.getElementById(activeInputId);
    if (!input) return; // Should allow backspace even if empty?

    if (passwordValues[activeInputId].length > 0) {
        passwordValues[activeInputId] = passwordValues[activeInputId].slice(0, -1);
        updateInputDisplay(activeInputId, true); // Immediate mask update
    }
}

function updateInputDisplay(id, maskAll) {
    const val = passwordValues[id];
    if (maskAll) {
        document.getElementById(id).value = '*'.repeat(val.length);
    } else {
        if (val.length > 0) {
            // Mask all except last char
            const masked = '*'.repeat(val.length - 1) + val.slice(-1);
            document.getElementById(id).value = masked;
        } else {
            document.getElementById(id).value = '';
        }
    }
}

function renderKeypad() {
    const container = document.getElementById('keypadContainer');
    container.innerHTML = '';

    // Container Styles
    // MUST include 'keypad-grid' because auth.css uses .keypad-grid .key-btn selectors!
    container.className = 'keypad-grid keypad-container';
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.padding = '8px';
    container.style.background = '#eef1f5';
    container.style.gap = '6px';

    const createBtn = (key, isFunc = false, className = "") => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `key-btn ${isFunc ? 'func-key' : ''} ${className}`;
        btn.style.flex = '1';
        btn.style.margin = '2px';
        btn.style.height = '42px';
        btn.style.borderRadius = '5px';
        btn.style.border = '1px solid #d1d5db';
        // btn.style.background = '#fff'; // MOVED TO CSS to enable hover
        btn.style.fontSize = '16px';
        btn.style.fontWeight = '600';
        btn.style.color = '#333';
        btn.style.cursor = 'pointer';

        // Touch highlight disable
        btn.style.webkitTapHighlightColor = 'transparent';

        if (key === 'Shift') {
            btn.textContent = 'Shift';
            btn.classList.toggle('active', isShift);
            if (isShift) {
                btn.className += ' btn-active'; // Use class for active state
                // btn.style.background = '#dbeafe'; // Handled by CSS .btn-active
                // btn.style.color = '#1e40af';
            } else {
                btn.className += ' btn-func'; // Use class for func
                // btn.style.background = '#e5e7eb';
            }
            btn.style.flex = '1.5';
            btn.onclick = toggleShift;
        } else if (key === 'Del') {
            // Backspace Icon (Arrow Left)
            btn.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5m7-7l-7 7 7 7" /></svg>';
            btn.className += ' btn-func';
            btn.style.flex = '1';
            // btn.style.background = '#e5e7eb';
            btn.onclick = handleDelete;
        } else if (key === '!#1' || key === 'abc') {
            btn.textContent = key;
            btn.className += ' btn-func';
            btn.style.flex = '1.2';
            // btn.style.background = '#e5e7eb';
            btn.onclick = () => switchMode(key === '!#1' ? 'spec' : 'abc');
        } else if (key === 'Space') {
            btn.textContent = 'Space';
            btn.style.flex = '4';
            btn.onclick = () => handleKeyInput(' ');
        } else if (key === '확인') {
            btn.textContent = '확인';
            // Explicitly set class string vs appending to ensure precedence order isn't weird, 
            // though with CSS selectors it shouldn't matter.
            // Using `btn.classList.add` is cleaner.
            btn.classList.add('btn-confirm');
            btn.style.flex = '1.2';
            btn.onclick = () => toggleKeypad(null);
        } else {
            let char = (keypadMode === 'abc' && isShift) ? key.toUpperCase() : key;
            btn.textContent = char;
            btn.onclick = () => handleKeyInput(char);
        }
        return btn;
    };

    // 1. Top Row: Numbers + Backspace (Always present in password mode)
    const numRowDiv = document.createElement('div');
    numRowDiv.style.display = 'flex';
    numRowDiv.style.width = '100%';
    numRowDiv.style.justifyContent = 'center';

    // Numbers 1-0
    const numbers = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'];
    numbers.forEach(num => numRowDiv.appendChild(createBtn(num)));
    // Backspace
    numRowDiv.appendChild(createBtn('Del', true));
    container.appendChild(numRowDiv);

    // 2. Middle Rows: Letters or Special Chars
    const layout = keyboardLayouts[keypadMode] || keyboardLayouts['abc'];

    if (Array.isArray(layout[0])) {
        layout.forEach(rowKeys => {
            const rowDiv = document.createElement('div');
            rowDiv.style.display = 'flex';
            rowDiv.style.width = '100%';
            rowDiv.style.justifyContent = 'center';

            rowKeys.forEach(key => {
                rowDiv.appendChild(createBtn(key));
            });
            container.appendChild(rowDiv);
        });
    }

    // 3. Bottom Row: [!#1/abc] [Space] [확인]
    const bottomRow = document.createElement('div');
    bottomRow.style.display = 'flex';
    bottomRow.style.width = '100%';
    bottomRow.style.justifyContent = 'center';

    // Mode Switch Button
    const modeLabel = keypadMode === 'abc' ? '!#1' : 'abc';
    bottomRow.appendChild(createBtn(modeLabel, true));

    // Space
    bottomRow.appendChild(createBtn('Space'));

    // Check
    bottomRow.appendChild(createBtn('확인', false)); // Pass false to avoid func-key grey style conflict

    container.appendChild(bottomRow);
}

const loginForm = document.querySelector('.login-form');
if (loginForm) { // 로그인 폼이 존재하는 페이지(login.html)에서만 실행
    loginForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const fields = [
            { id: 'userId', box: 'userIdBox', err: 'userIdError', msg: '아이디를 입력하세요.' },
            { id: 'userPassword', box: 'userPasswordBox', err: 'userPasswordError', msg: '비밀번호를 입력하세요.' }
        ];

        let isValid = true;

        fields.forEach(field => {
            const input = document.getElementById(field.id);
            const errorEl = document.getElementById(field.err);
            const boxEl = document.getElementById(field.box);

            if (!input.value.trim()) {
                if (errorEl) {
                    errorEl.textContent = field.msg;
                    errorEl.style.display = 'block';
                }
                if (boxEl) boxEl.classList.add('error');
                isValid = false;
            } else {
                if (errorEl) errorEl.style.display = 'none';
                if (boxEl) boxEl.classList.remove('error');
            }
        });

        if (isValid) {
            this.submit(); // 모든 검증 통과 시 실제 제출
        }
    });
}

// ===== Global Modal Functions =====
function openModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
        modal.classList.add('active');
    }
}

function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
        modal.classList.remove('active');
    }
}

// Close modal when clicking outside
window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        closeModal(e.target.id);
    }
});

// ===== Security Keypad Helper Functions =====
function switchMode(mode) {
    keypadMode = (keypadMode === 'abc' && mode === 'spec') ? 'spec' : 'abc';
    renderKeypad();
}

function toggleShift() {
    isShift = !isShift;
    renderKeypad();
}

function handleKeyInput(char) {
    if (!activeInputId) return;
    const input = document.getElementById(activeInputId);
    if (!input) return;

    // Clear existing timer if user types fast
    if (maskingTimers[activeInputId]) {
        clearTimeout(maskingTimers[activeInputId]);
        // Force full mask of previous state
        updateInputDisplay(activeInputId, true);
    }

    // Update real value
    passwordValues[activeInputId] += char;

    // Update display: all stars + char
    updateInputDisplay(activeInputId, false);

    // Set timer to mask this char
    maskingTimers[activeInputId] = setTimeout(() => {
        updateInputDisplay(activeInputId, true);
        maskingTimers[activeInputId] = null;
    }, 500);
}

// ===== Security Keypad Functions =====
function toggleKeypad(targetId) {
    const keypad = document.getElementById('securityKeypad');
    if (!keypad) return;

    // Close logic
    if (!targetId) {
        keypad.classList.remove('active');
        // Force full mask on close for security
        if (activeInputId) {
            updateInputDisplay(activeInputId, true);
            // Revert type to password on close
            const input = document.getElementById(activeInputId);
            if (input) input.type = 'password';
        }
        activeInputId = null;
        return;
    }

    activeInputId = targetId;
    const targetInput = document.getElementById(targetId);
    if (!targetInput) return;

    // Change type to text to allow manual masking (showing last char)
    targetInput.type = 'text';

    // Initialize storage for this input if needed
    if (!passwordValues[targetId]) {
        passwordValues[targetId] = '';
    }

    // Calculate Position
    const rect = targetInput.getBoundingClientRect();
    const keypadWidth = 320;

    keypad.style.position = 'fixed';
    keypad.style.top = `${rect.bottom + 8}px`; // 8px gap
    const centerPos = rect.left + (rect.width / 2);

    keypad.style.left = `${centerPos}px`;
    keypad.style.width = `${keypadWidth}px`;
    keypad.style.transform = 'translateX(-50%)';

    keypad.classList.add('active');
    renderKeypad();
}